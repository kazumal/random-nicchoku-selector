<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ—¥ç›´é †æ±ºå®š</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; max-width: 720px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 1.4rem; margin-bottom: 0.5rem; }
    textarea, input, button, select { font-size: 16px; }
    textarea { width: 100%; box-sizing: border-box; }
    textarea#names { height: 160px; }
    textarea#result { height: 300px; background: #f6f6f6; padding: 12px; border-radius: 8px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    small { color: #666; }
    .btn-line { background: #06c755; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
    .btn-line:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>æ—¥ç›´é †ã‚’æ±ºã‚ã‚‹</h1>
  <p><small>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ãŸã³ã«ãƒ©ãƒ³ãƒ€ãƒ ã«é †åºãŒæ±ºã¾ã‚Šã¾ã™ã€‚</small></p>

  <label>ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆ1è¡Œ1äººï¼‰</label>
  <textarea id="names" placeholder="å±±ç”°å¤ªéƒ\nä½è—¤èŠ±å­\nä¼Šè—¤å¥å¤ª\n..."></textarea>

  <div class="row" style="margin: 8px 0;">
    <button id="gen">é †ç•ªã‚’ä½œã‚‹</button>
    <button id="copy">ã‚³ãƒ”ãƒ¼</button>
    <button id="sendLine" class="btn-line" style="display:none;">LINEã«é€ä¿¡</button>
  </div>

  <textarea id="result" readonly></textarea>

  <hr style="margin: 24px 0;">

  <h2 style="font-size: 1.2rem; margin-bottom: 8px;">ğŸ“… Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²</h2>
  <p><small>å–¶æ¥­æ—¥ï¼ˆæœˆã€œé‡‘ï¼‰ã«æ—¥ç›´äºˆå®šã‚’è‡ªå‹•ç™»éŒ²ã—ã¾ã™</small></p>

  <div id="authSection">
    <button id="authorizeButton" style="background: #4285f4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
      Googleã§ãƒ­ã‚°ã‚¤ãƒ³
    </button>
    <button id="signoutButton" style="display: none; background: #666; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-left: 8px;">
      ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    </button>
  </div>

  <div id="calendarSection" style="display: none; margin-top: 16px;">
    <div class="row" style="margin: 8px 0;">
      <label for="targetMonth">å¯¾è±¡æœˆ</label>
      <input id="targetMonth" type="month" />
      <button id="addToCalendar" style="background: #34a853; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
        ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²
      </button>
    </div>
    <p id="calendarStatus" style="color: #666; font-size: 0.9rem;"></p>
  </div>

  <script>
    // ========================================
    // Google Calendar API è¨­å®š
    // ========================================
    const API_KEY = "AIzaSyChGcto89INvvGaGwyGqd0Dvz-iyAeExVI";
    const CLIENT_ID = "330190960613-5607fg4e4kv2gdlgorshr1rduj38rgot.apps.googleusercontent.com";
    const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
    const SCOPES = "https://www.googleapis.com/auth/calendar.events";

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;

    // ========================================
    // LIFFè¨­å®š
    // ========================================
    // â†“ LINE Developers ã§ç™ºè¡Œã•ã‚ŒãŸ LIFF ID ã‚’å…¥ã‚Œã¦ãã ã•ã„
    const LIFF_ID = "YOUR_LIFF_ID";  // ä¾‹: "1234567890-abcdefgh"

    let liffInitialized = false;

    // LIFFåˆæœŸåŒ–
    (async () => {
      try {
        await liff.init({ liffId: LIFF_ID });
        liffInitialized = true;

        // LINEã‚¢ãƒ—ãƒªå†…ã§é–‹ã„ã¦ã„ã‚‹ã‹ã‚’åˆ¤å®š
        if (liff.isInClient()) {
          console.log("LINEã‚¢ãƒ—ãƒªå†…ã§å®Ÿè¡Œä¸­");
          // LINEé€ä¿¡ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          document.getElementById('sendLine').style.display = 'inline-block';
        } else {
          console.log("LINEã‚¢ãƒ—ãƒªå¤–ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã‹ã‚Œã¦ã„ã¾ã™");
        }

        // å°†æ¥ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç­‰ãŒæ¬²ã—ããªã£ãŸã‚‰ï¼š
        // const profile = await liff.getProfile();
        // console.log(profile.displayName);
      } catch (e) {
        console.error("LIFF init error:", e);
      }
    })();

    // ========================================
    // Google Calendar API åˆæœŸåŒ–
    // ========================================
    
    // gapiåˆæœŸåŒ–
    function gapiLoaded() {
      gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
      });
      gapiInited = true;
      maybeEnableButtons();
    }

    // GISåˆæœŸåŒ–
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // å¾Œã§è¨­å®š
      });
      gisInited = true;
      maybeEnableButtons();
    }

    function maybeEnableButtons() {
      if (gapiInited && gisInited) {
        document.getElementById('authorizeButton').style.display = 'inline-block';
      }
    }

    // èªè¨¼å‡¦ç†
    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          throw (resp);
        }
        document.getElementById('signoutButton').style.display = 'inline-block';
        document.getElementById('authorizeButton').style.display = 'none';
        document.getElementById('calendarSection').style.display = 'block';
        
        // åˆæœŸå€¤ï¼šä»Šæœˆ
        const now = new Date();
        document.getElementById('targetMonth').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      };

      if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    function handleSignoutClick() {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        document.getElementById('authorizeButton').style.display = 'inline-block';
        document.getElementById('signoutButton').style.display = 'none';
        document.getElementById('calendarSection').style.display = 'none';
        document.getElementById('calendarStatus').textContent = '';
      }
    }

    // å–¶æ¥­æ—¥ï¼ˆæœˆã€œé‡‘ï¼‰ã‚’å–å¾—
    function getWeekdays(year, month) {
      const weekdays = [];
      const daysInMonth = new Date(year, month, 0).getDate();
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month - 1, day);
        const dayOfWeek = date.getDay();
        // 0=æ—¥æ›œ, 6=åœŸæ›œ ã‚’é™¤å¤–
        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
          weekdays.push(date);
        }
      }
      return weekdays;
    }

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ
    async function addToCalendar() {
      const raw = document.getElementById('names').value.split('\n').map(s => s.trim()).filter(Boolean);
      if (raw.length === 0) {
        alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const targetMonth = document.getElementById('targetMonth').value;
      if (!targetMonth) {
        alert('å¯¾è±¡æœˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const [year, month] = targetMonth.split('-').map(n => parseInt(n, 10));
      
      // å–¶æ¥­æ—¥ã‚’å–å¾—
      const weekdays = getWeekdays(year, month);
      if (weekdays.length === 0) {
        alert('å–¶æ¥­æ—¥ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      // ãƒ¡ãƒ³ãƒãƒ¼ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
      const shuffled = shuffle(raw);
      
      document.getElementById('calendarStatus').textContent = 'ç™»éŒ²ä¸­...';
      document.getElementById('addToCalendar').disabled = true;

      try {
        let successCount = 0;
        
        for (let i = 0; i < weekdays.length; i++) {
          const date = weekdays[i];
          const memberIndex = i % shuffled.length;
          const nextMemberIndex = (i + 1) % shuffled.length;
          
          // æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã«
          const dateStr = date.toISOString().split('T')[0];
          
          // ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ
          const event = {
            summary: `æ—¥ç›´ï¼š${shuffled[memberIndex]}ï¼ˆ${shuffled[nextMemberIndex]}ï¼‰`,
            start: {
              date: dateStr,
            },
            end: {
              date: dateStr,
            },
            colorId: '5', // é»„è‰²
          };

          await gapi.client.calendar.events.insert({
            calendarId: 'primary',
            resource: event,
          });
          
          successCount++;
          document.getElementById('calendarStatus').textContent = `ç™»éŒ²ä¸­... ${successCount}/${weekdays.length}`;
        }

        document.getElementById('calendarStatus').textContent = `âœ… ${successCount}ä»¶ã®äºˆå®šã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼`;
        alert(`${successCount}ä»¶ã®æ—¥ç›´äºˆå®šã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²ã—ã¾ã—ãŸï¼`);
      } catch (error) {
        console.error('Calendar API error:', error);
        document.getElementById('calendarStatus').textContent = 'âŒ ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ';
        alert('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¸ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      } finally {
        document.getElementById('addToCalendar').disabled = false;
      }
    }

    // ========================================
    // æ—¥ç›´ã‚·ãƒ•ãƒˆä½œæˆæ©Ÿèƒ½
    // ========================================
    
    // --- ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼ˆFisher-Yatesï¼‰ ---
    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    const $names = document.getElementById('names');
    const $result = document.getElementById('result');

    // ä¿å­˜/å¾©å…ƒ
    const saved = localStorage.getItem('nichoku_names');
    if (saved) $names.value = JSON.parse(saved).join('\n');

    document.getElementById('gen').onclick = () => {
      const raw = $names.value.split('\n').map(s => s.trim()).filter(Boolean);
      if (raw.length === 0) { $result.textContent = 'ãƒ¡ãƒ³ãƒãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
      localStorage.setItem('nichoku_names', JSON.stringify(raw));

      const shuffled = shuffle(raw);
      const text = shuffled.map((name, i) => `${i + 1}. ${name}`).join('\n');
      $result.textContent = text;
    };

    document.getElementById('copy').onclick = async () => {
      if (!$result.textContent) return;
      try {
        await navigator.clipboard.writeText($result.textContent);
        alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      } catch { alert('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸ'); }
    };

    // LINEé€ä¿¡ãƒœã‚¿ãƒ³
    document.getElementById('sendLine').onclick = async () => {
      if (!$result.textContent) {
        alert('å…ˆã«é †ç•ªã‚’ä½œæˆã—ã¦ãã ã•ã„');
        return;
      }
      if (!liffInitialized) {
        alert('LIFFåˆæœŸåŒ–ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„');
        return;
      }
      
      try {
        // LINEãƒˆãƒ¼ã‚¯ã«é€ä¿¡
        await liff.shareTargetPicker([
          {
            type: "text",
            text: `ğŸ“‹ æ—¥ç›´é †\n\n${$result.textContent}`
          }
        ]);
        // é€ä¿¡æˆåŠŸå¾Œã¯LIFFã‚’é–‰ã˜ã‚‹ã“ã¨ã‚‚ã§ãã‚‹
        // liff.closeWindow();
      } catch (e) {
        console.error('LINEé€ä¿¡ã‚¨ãƒ©ãƒ¼:', e);
        if (e.code === 'UNAUTHORIZED') {
          alert('é€ä¿¡ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        } else {
          alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }
    };

    // ========================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    // ========================================
    
    // èªè¨¼ãƒœã‚¿ãƒ³ï¼ˆDOMContentLoadedå¾Œã«è¨­å®šï¼‰
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('authorizeButton').addEventListener('click', handleAuthClick);
      document.getElementById('signoutButton').addEventListener('click', handleSignoutClick);
      document.getElementById('addToCalendar').addEventListener('click', addToCalendar);
    });
  </script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
</body>
</html>
